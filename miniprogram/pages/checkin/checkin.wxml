<!--pages/checkin/checkin.wxml-->
<view class="page-container">
  <!-- 固定顶部登录栏 -->
  <view class="header-bar">
    <view class="user-section" wx:if="{{isLogin}}" bindtap="onAvatarTap">
      <image class="user-avatar" src="{{userInfo.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
      <text class="user-name">{{userInfo.nickName}}</text>
    </view>
    <view class="login-section" wx:else>
      <button class="login-btn" bindtap="showLoginModal">点击登录</button>
    </view>
    <view class="date-section">
      <text class="current-date">{{currentDate}}</text>
    </view>
  </view>

  <!-- 登录弹窗 -->
  <view class="login-modal" wx:if="{{showLoginModal}}" bindtap="hideLoginModal">
    <view class="modal-content" catchtap="">
      <view class="modal-header">
        <text class="modal-title">授权登录</text>
        <view class="modal-close" bindtap="hideLoginModal">×</view>
      </view>
      <view class="modal-body">
        <button class="avatar-selector" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar">
          <image class="temp-avatar" src="{{tempAvatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
          <text class="avatar-tip">点击选择头像</text>
        </button>
        <input class="nickname-input" type="nickname" placeholder="点击输入框自动填充昵称" bind:blur="onNicknameChange" value="{{tempNickName}}" />
        <button class="confirm-login-btn" bindtap="submitUserInfo">确认登录</button>
      </view>
    </view>
  </view>

  <!-- 用户菜单 -->
  <view class="user-menu" wx:if="{{showUserMenu}}" bindtap="hideUserMenu">
    <view class="menu-content" catchtap="">
      <view class="menu-item" bindtap="goToProfile">
        <text>个人中心</text>
      </view>
      <view class="menu-item" bindtap="logout">
        <text>退出登录</text>
      </view>
    </view>
  </view>

  <view class="content-container">

    <!-- 打卡模块 -->
    <view class="checkin-modules">
      <!-- 预习提问模块 -->
      <view class="module-card">
        <view class="module-header">
          <view class="module-icon">📚</view>
          <view class="module-title">预习提问</view>
        </view>
        <view class="module-content">
          <view class="questions-list">
            <view class="question-item" wx:for="{{questions}}" wx:key="index">
              <textarea 
                class="question-input" 
                placeholder="请输入预习问题..."
                value="{{item}}"
                data-index="{{index}}"
                bindinput="onQuestionInput"
                maxlength="200">
              </textarea>
              <view class="question-actions" wx:if="{{questions.length > 1}}">
                <button class="btn-delete" data-index="{{index}}" bindtap="deleteQuestion">删除</button>
              </view>
            </view>
          </view>
          <view class="module-actions">
            <button class="btn btn-secondary" bindtap="addQuestion" wx:if="{{questions.length < 5}}">
              添加问题
            </button>
          </view>
        </view>
      </view>

      <!-- 视频上传模块 -->
      <view class="module-card">
        <view class="module-header">
          <view class="module-icon">🎥</view>
          <view class="module-title">错题讲解视频</view>
        </view>
        <view class="module-content">
          <view class="video-upload" wx:if="{{!videoInfo.url}}">
            <view class="upload-area" bindtap="chooseVideo">
              <view class="upload-icon">📹</view>
              <text class="upload-text">点击上传讲解视频</text>
              <text class="upload-hint">支持5分钟内视频</text>
            </view>
          </view>
          <view class="video-preview" wx:else>
            <video class="preview-video" src="{{videoInfo.url}}" poster="{{videoInfo.cover}}" controls></video>
            <button class="btn btn-delete" bindtap="deleteVideo">删除视频</button>
          </view>
        </view>
      </view>

      <!-- 学习日记模块 -->
      <view class="module-card">
        <view class="module-header">
          <view class="module-icon">📝</view>
          <view class="module-title">学习日记</view>
        </view>
        <view class="module-content">
          <textarea 
            class="diary-input" 
            placeholder="记录今天的学习心得和收获..."
            value="{{diary}}"
            bindinput="onDiaryInput"
            maxlength="1000">
          </textarea>
          <view class="char-count">{{diary.length}}/1000</view>
          
          <!-- 图片上传 -->
          <view class="images-section">
            <view class="images-grid">
              <view class="image-item" wx:for="{{images}}" wx:key="index">
                <image class="diary-image" src="{{item}}" mode="aspectFill" data-index="{{index}}" bindtap="previewImage"></image>
                <view class="image-delete" data-index="{{index}}" bindtap="deleteImage">×</view>
              </view>
              <view class="image-add" bindtap="chooseImages" wx:if="{{images.length < 9}}">
                <text class="add-icon">+</text>
                <text class="add-text">添加图片</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 提交按钮 -->
    <view class="submit-section">
      <button class="btn btn-primary btn-submit" bindtap="submitCheckin" disabled="{{submitting}}">
        {{submitting ? '提交中...' : '提交今日打卡'}}
      </button>
    </view>

    <!-- 成功提示 -->
    <view class="success-toast" wx:if="{{showSuccessToast}}">
      <view class="toast-content">
        <view class="toast-icon">✅</view>
        <text class="toast-text">打卡成功！</text>
      </view>
    </view>
  </view>
</view>