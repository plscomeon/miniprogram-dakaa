<!--pages/checkin/checkin.wxml-->
<view class="page-container">
  <!-- 固定顶部区域 -->
  <view class="header-container">
    <!-- 用户信息和日期在同一行 -->
    <view class="header-top">
      <view class="user-section" wx:if="{{isLogin && userInfo.nickName}}" bindtap="onAvatarTap">
        <image 
          class="user-avatar" 
          src="{{userInfo.avatarUrl || '/images/default-avatar.png'}}" 
          mode="aspectFill"
          binderror="onAvatarError"
          lazy-load="{{false}}">
        </image>
        <view class="user-info">
          <text class="user-name">{{userInfo.nickName || '微信用户'}}</text>
          <text class="motivation-text" wx:if="{{motivationText}}">{{motivationText}}</text>
        </view>
      </view>
      <view class="login-section" wx:else>
        <button class="login-btn" bindtap="showLoginModal">登录</button>
      </view>
      <view class="date-section">
        <view class="date-info">
        </view>
      </view>
    </view>
  </view>

  <!-- 登录弹窗 -->
  <view class="login-modal" wx:if="{{showLoginModal}}" bindtap="hideLoginModal">
    <view class="modal-content" catchtap="">
      <view class="modal-header">
        <text class="modal-title">授权登录</text>
        <view class="modal-close" bindtap="hideLoginModal">×</view>
      </view>
      <view class="modal-body">
        <view class="login-description">
          <text class="description-text">获取您的微信头像和昵称，用于个性化显示</text>
        </view>
        
        <!-- 微信一键登录按钮 -->
        <button 
          class="one-click-login-btn" 
          bindtap="oneClickLogin"
          disabled="{{submitting}}">
          <view class="login-btn-content">
            <view class="wechat-icon">💬</view>
            <text class="login-btn-text">{{submitting ? '登录中...' : '微信一键登录'}}</text>
          </view>
        </button>
        
        <view class="privacy-notice">
          <text class="notice-text">我们将严格保护您的个人信息</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 用户菜单 -->
  <view class="user-menu" wx:if="{{showUserMenu}}" bindtap="hideUserMenu">
    <view class="menu-content" catchtap="">
      <view class="menu-item" bindtap="goToProfile">
        <text>个人中心</text>
      </view>
      <view class="menu-item" bindtap="logout">
        <text>退出登录</text>
      </view>
    </view>
  </view>

  <view class="content-container">

    <!-- 打卡模块 -->
    <view class="checkin-modules">
      <!-- 预习提问模块 -->
      <view class="module-card">
        <view class="module-header">
          <view class="module-title">预习提问</view>
        </view>
        <view class="module-content">
          <view class="questions-list">
            <view class="question-item" wx:for="{{questions}}" wx:key="index">
              <textarea 
                class="question-input" 
                placeholder="请输入预习问题..."
                value="{{item}}"
                data-index="{{index}}"
                bindinput="onQuestionInput"
                maxlength="200">
              </textarea>
              <view class="question-actions" wx:if="{{questions.length > 1}}">
                <button class="btn-delete" data-index="{{index}}" bindtap="deleteQuestion">删除</button>
              </view>
            </view>
          </view>
          <view class="module-actions">
            <button class="btn btn-secondary" bindtap="addQuestion" wx:if="{{questions.length < 5}}">
              添加问题
            </button>
          </view>
        </view>
      </view>

      <!-- 说错题模块 -->
      <view class="module-card">
        <view class="module-header">
          <view class="module-title">说错题</view>
        </view>
        <view class="module-content">
          <!-- 错题图片上传 -->
          <view class="mistake-images-section">
            <view class="mistake-images-grid">
              <view class="mistake-image-item" wx:for="{{mistakeImages}}" wx:key="index">
                <image class="mistake-image" src="{{item}}" mode="aspectFill" data-index="{{index}}" bindtap="previewMistakeImage"></image>
                <view class="mistake-image-delete" data-index="{{index}}" bindtap="deleteMistakeImage">×</view>
              </view>
              <view class="mistake-image-add" bindtap="chooseMistakeImages" wx:if="{{mistakeImages.length < 9}}">
                <text class="add-icon">+</text>
                <text class="add-text">添加错题图片</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- 学习日记模块 -->
      <view class="module-card">
        <view class="module-header">
          <view class="module-title">学习日记</view>
        </view>
        <view class="module-content">
          <textarea 
            class="diary-input" 
            placeholder="记录今天的学习心得和收获..."
            value="{{diary}}"
            bindinput="onDiaryInput"
            maxlength="1000">
          </textarea>
          <view class="char-count">{{diary.length}}/1000</view>
          
          <!-- 图片上传 -->
          <view class="images-section">
            <view class="images-grid">
              <view class="image-item" wx:for="{{images}}" wx:key="index">
                <image class="diary-image" src="{{item}}" mode="aspectFill" data-index="{{index}}" bindtap="previewImage"></image>
                <view class="image-delete" data-index="{{index}}" bindtap="deleteImage">×</view>
              </view>
              <view class="image-add" bindtap="chooseImages" wx:if="{{images.length < 9}}">
                <text class="add-icon">+</text>
                <text class="add-text">添加图片</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 提交按钮 -->
    <view class="submit-section">
      <button class="btn btn-primary btn-submit" bindtap="submitCheckin" disabled="{{submitting}}">
        {{submitting ? '提交中...' : '提交今日打卡'}}
      </button>
    </view>

    <!-- 成功提示 -->
    <view class="success-toast" wx:if="{{showSuccessToast}}">
      <view class="toast-content">
        <view class="toast-icon">✅</view>
        <text class="toast-text">打卡成功！</text>
      </view>
    </view>
  </view>
</view>