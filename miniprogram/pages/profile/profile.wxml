<!--pages/profile/profile.wxml-->
<view class="page-container">
  <view class="content-container">
    <!-- 用户信息卡片 -->
    <view class="user-card" bindtap="changeAvatar">
      <view class="user-avatar">
        <image class="avatar-img" src="{{userInfo.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
      </view>
      <view class="user-info">
        <text class="user-name">{{userInfo.nickName || '学习者'}}</text>
        <text class="user-desc">坚持学习，每天进步</text>
      </view>
    </view>

    <!-- 数据统计 -->
    <view class="stats-grid">
      <view class="stats-item">
        <text class="stats-number">{{totalDays}}</text>
        <text class="stats-label">学习天数</text>
      </view>
      <view class="stats-item">
        <text class="stats-number">{{streakDays}}</text>
        <text class="stats-label">连续天数</text>
      </view>
      <view class="stats-item">
        <text class="stats-number">{{totalMistakes}}</text>
        <text class="stats-label">错题数量</text>
      </view>
      <view class="stats-item">
        <text class="stats-number">{{totalWords}}</text>
        <text class="stats-label">文字记录</text>
      </view>
    </view>

    <!-- 成就系统 -->
    <view class="achievement-card">
      <view class="card-header">
        <text class="card-title">🏆 学习成就</text>
        <text class="achievement-count">{{unlockedCount}}/{{totalAchievements}}</text>
      </view>
      <view class="achievement-list">
        <view class="achievement-item {{item.unlocked ? 'unlocked' : 'locked'}}" wx:for="{{achievements}}" wx:key="id">
          <view class="achievement-info">
            <text class="achievement-icon">{{item.icon}}</text>
            <view class="achievement-details">
              <text class="achievement-name">{{item.name}}</text>
              <text class="achievement-desc">{{item.description}}</text>
            </view>
          </view>
          <view class="achievement-status">
            <text wx:if="{{item.unlocked}}" class="status-unlocked">✅ 已获得</text>
            <text wx:else class="status-locked">{{item.progress}}/{{item.target}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 奖励系统 -->
    <view class="reward-system-card">
      <view class="card-header">
        <text class="card-title">🎁 奖励系统</text>
        <text class="phone-status" style="color: {{getStatusColor(isPhoneRecovered)}}">
          {{getStatusText(isPhoneRecovered, phoneRecoveryDays)}}
        </text>
      </view>
      
      <!-- 手机使用权状态 -->
      <view class="phone-usage-status">
        <view class="usage-info">
          <view class="usage-item">
            <text class="usage-label">可用时长</text>
            <text class="usage-value">{{formatTime(phoneUsageRights)}}</text>
          </view>
          <view class="usage-item" wx:if="{{isPhoneRecovered}}">
            <text class="usage-label">回收倒计时</text>
            <text class="usage-value recovery">{{phoneRecoveryDays}}天</text>
          </view>
        </view>
        <button class="usage-btn" bindtap="showPhoneUsageManager" disabled="{{isPhoneRecovered}}">
          {{isPhoneRecovered ? '手机已回收' : '使用时间'}}
        </button>
      </view>

      <!-- 奖励规则说明 -->
      <view class="reward-rules">
        <text class="rules-title">📋 奖励规则</text>
        <view class="rule-item">
          <text class="rule-text">✅ 打卡1天 = 获得1小时手机使用权</text>
        </view>
        <view class="rule-item">
          <text class="rule-text">❌ 忘记打卡1天 = 手机回收1天</text>
        </view>
        <view class="rule-item">
          <text class="rule-text">⚠️ 忘记打卡2天 = 手机回收3天</text>
        </view>
      </view>

      <!-- 最近奖励和惩罚 -->
      <view class="recent-activities">
        <view class="activity-section" wx:if="{{rewardHistory.length > 0}}">
          <view class="activity-header" bindtap="showRewardHistory">
            <text class="activity-title">🎉 最近奖励</text>
            <text class="activity-more">查看全部 ›</text>
          </view>
          <view class="activity-item" wx:for="{{rewardHistory}}" wx:key="id">
            <text class="activity-message">{{item.message}}</text>
            <text class="activity-date">{{item.date}}</text>
          </view>
        </view>

        <view class="activity-section" wx:if="{{penaltyHistory.length > 0}}">
          <view class="activity-header" bindtap="showPenaltyHistory">
            <text class="activity-title">⚠️ 最近惩罚</text>
            <text class="activity-more">查看全部 ›</text>
          </view>
          <view class="activity-item penalty" wx:for="{{penaltyHistory}}" wx:key="id">
            <text class="activity-message">{{item.message}}</text>
            <text class="activity-date">{{item.date}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 功能菜单 -->
    <view class="menu-section">
      <view class="menu-item" bindtap="goToMistakes">
        <text class="menu-title">我的错题本</text>
        <text class="menu-arrow">›</text>
      </view>
      <view class="menu-item" bindtap="exportData">
        <text class="menu-title">导出数据</text>
        <text class="menu-arrow">›</text>
      </view>
      <view class="menu-item" bindtap="shareApp">
        <text class="menu-title">分享应用</text>
        <text class="menu-arrow">›</text>
      </view>
      <view class="menu-item" bindtap="feedback">
        <text class="menu-title">意见反馈</text>
        <text class="menu-arrow">›</text>
      </view>
      <view class="menu-item" bindtap="about">
        <text class="menu-title">关于我们</text>
        <text class="menu-arrow">›</text>
      </view>
    </view>

    <!-- 设置选项 -->
    <view class="settings-section">
      <view class="settings-item">
        <text class="settings-title">每日提醒</text>
        <switch class="settings-switch" checked="{{reminderEnabled}}" bindchange="toggleReminder"></switch>
      </view>
      <view class="settings-item">
        <text class="settings-title">数据同步</text>
        <switch class="settings-switch" checked="{{syncEnabled}}" bindchange="toggleSync"></switch>
      </view>
      <view class="settings-item" bindtap="about">
        <text class="settings-title">缓存大小</text>
        <text class="settings-value">{{cacheSize}}</text>
      </view>
    </view>
  </view>
</view>

<!-- 导出数据弹窗 -->
<view class="modal-overlay {{showExportModal ? 'show' : ''}}" bindtap="hideExportModal">
  <view class="modal-content" catchtap="">
    <view class="modal-header">
      <text class="modal-title">导出学习数据</text>
      <button class="modal-close" bindtap="hideExportModal">×</button>
    </view>
    <view class="modal-body">
      <view class="export-options">
        <view class="export-option {{exportType === 'excel' ? 'selected' : ''}}" bindtap="selectExportType" data-type="excel">
          <text class="option-title">Excel表格</text>
        </view>
        <view class="export-option {{exportType === 'pdf' ? 'selected' : ''}}" bindtap="selectExportType" data-type="pdf">
          <text class="option-title">PDF报告</text>
        </view>
      </view>
      <view class="date-range">
        <text class="range-label">时间范围：</text>
        <view class="date-options">
          <view class="date-option {{dateRange === 'week' ? 'active' : ''}}" bindtap="selectDateRange" data-range="week">近一周</view>
          <view class="date-option {{dateRange === 'month' ? 'active' : ''}}" bindtap="selectDateRange" data-range="month">近一月</view>
          <view class="date-option {{dateRange === 'all' ? 'active' : ''}}" bindtap="selectDateRange" data-range="all">全部</view>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideExportModal">取消</button>
      <button class="btn btn-primary" bindtap="confirmExport">导出</button>
    </view>
  </view>
</view>

<!-- 手机使用权管理弹窗 -->
<view class="modal-overlay {{showPhoneUsageModal ? 'show' : ''}}" bindtap="hidePhoneUsageModal">
  <view class="modal-content" catchtap="">
    <view class="modal-header">
      <text class="modal-title">📱 手机使用权管理</text>
      <button class="modal-close" bindtap="hidePhoneUsageModal">×</button>
    </view>
    <view class="modal-body">
      <!-- 状态卡片 -->
      <view class="status-card">
        <view class="status-header">
          <text class="status-icon">📱</text>
          <view class="status-info">
            <text class="status-title">手机使用状态</text>
            <text class="status-subtitle" style="color: {{statusColor}}">{{statusText}}</text>
          </view>
        </view>
        <view class="status-time">
          <text class="time-label">可用时长</text>
          <text class="time-value">{{formattedUsageRights}}</text>
        </view>
      </view>

      <!-- 快速使用按钮 -->
      <view class="quick-usage" wx:if="{{!isPhoneRecovered}}">
        <text class="section-title">⚡ 快速使用</text>
        <view class="usage-grid">
          <button class="usage-btn small" bindtap="usePhoneTime" data-minutes="15" 
                  disabled="{{phoneUsageRights < 15}}">
            <text class="btn-time">15分钟</text>
            <text class="btn-desc">短暂休息</text>
          </button>
          <button class="usage-btn small" bindtap="usePhoneTime" data-minutes="30" 
                  disabled="{{phoneUsageRights < 30}}">
            <text class="btn-time">30分钟</text>
            <text class="btn-desc">娱乐时间</text>
          </button>
          <button class="usage-btn large" bindtap="usePhoneTime" data-minutes="60" 
                  disabled="{{phoneUsageRights < 60}}">
            <text class="btn-time">1小时</text>
            <text class="btn-desc">自由使用</text>
          </button>
          <button class="usage-btn large" bindtap="usePhoneTime" data-minutes="120" 
                  disabled="{{phoneUsageRights < 120}}">
            <text class="btn-time">2小时</text>
            <text class="btn-desc">长时间使用</text>
          </button>
        </view>
      </view>

      <!-- 回收状态提示 -->
      <view class="recovery-notice" wx:if="{{isPhoneRecovered}}">
        <text class="notice-icon">🚫</text>
        <view class="notice-content">
          <text class="notice-title">手机已被回收</text>
          <text class="notice-desc">还需等待 {{phoneRecoveryDays}} 天才能使用</text>
          <text class="notice-tip">坚持打卡可以避免手机被回收</text>
        </view>
      </view>

      <!-- 使用统计 -->
      <view class="usage-stats" wx:if="{{syncResult}}">
        <text class="section-title">📊 使用统计</text>
        <view class="stats-grid">
          <view class="stat-item">
            <text class="stat-value">{{formatTime(syncResult.shouldHave)}}</text>
            <text class="stat-label">总获得</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{formatTime(syncResult.used)}}</text>
            <text class="stat-label">已使用</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{formatTime(syncResult.penalty)}}</text>
            <text class="stat-label">被扣除</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{formatTime(syncResult.available)}}</text>
            <text class="stat-label">可使用</text>
          </view>
        </view>
      </view>
      
      <!-- 使用提示 -->
      <view class="usage-tips">
        <text class="tips-title">💡 使用说明</text>
        <view class="tips-list">
          <text class="tips-item">• 每天打卡获得1小时使用权</text>
          <text class="tips-item">• 连续7天额外获得2小时</text>
          <text class="tips-item">• 忘记打卡会被扣除使用权</text>
          <text class="tips-item">• 使用时长实时从余额中扣除</text>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- 奖励历史弹窗 -->
<view class="modal-overlay {{showRewardModal ? 'show' : ''}}" bindtap="hideRewardModal">
  <view class="modal-content" catchtap="">
    <view class="modal-header">
      <text class="modal-title">🎉 奖励历史</text>
      <button class="modal-close" bindtap="hideRewardModal">×</button>
    </view>
    <view class="modal-body">
      <view class="history-list">
        <view class="history-item" wx:for="{{rewardHistory}}" wx:key="id">
          <view class="history-content">
            <text class="history-title">{{item.title}}</text>
            <text class="history-message">{{item.message}}</text>
          </view>
          <view class="history-meta">
            <text class="history-date">{{item.date}}</text>
            <text class="history-reward" wx:if="{{item.phoneTime}}">+{{formatTime(item.phoneTime)}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- 惩罚历史弹窗 -->
<view class="modal-overlay {{showPenaltyModal ? 'show' : ''}}" bindtap="hidePenaltyModal">
  <view class="modal-content" catchtap="">
    <view class="modal-header">
      <text class="modal-title">⚠️ 惩罚历史</text>
      <button class="modal-close" bindtap="hidePenaltyModal">×</button>
    </view>
    <view class="modal-body">
      <view class="history-list">
        <view class="history-item penalty" wx:for="{{penaltyHistory}}" wx:key="id">
          <view class="history-content">
            <text class="history-title">{{item.title}}</text>
            <text class="history-message">{{item.message}}</text>
          </view>
          <view class="history-meta">
            <text class="history-date">{{item.date}}</text>
            <text class="history-penalty" wx:if="{{item.recoveryDays}}">回收{{item.recoveryDays}}天</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>