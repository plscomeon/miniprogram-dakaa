<!--pages/profile/profile.wxml-->
<view class="page-container">
  <view class="content-container">
    <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
    <view class="user-card" bindtap="changeAvatar">
      <view class="user-avatar">
        <image class="avatar-img" src="{{userInfo.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
      </view>
      <view class="user-info">
        <text class="user-name">{{userInfo.nickName || 'å­¦ä¹ è€…'}}</text>
        <text class="user-desc">åšæŒå­¦ä¹ ï¼Œæ¯å¤©è¿›æ­¥</text>
      </view>
    </view>

    <!-- æ•°æ®ç»Ÿè®¡ -->
    <view class="stats-grid">
      <view class="stats-item">
        <text class="stats-number">{{totalDays}}</text>
        <text class="stats-label">å­¦ä¹ å¤©æ•°</text>
      </view>
      <view class="stats-item">
        <text class="stats-number">{{streakDays}}</text>
        <text class="stats-label">è¿ç»­å¤©æ•°</text>
      </view>
      <view class="stats-item">
        <text class="stats-number">{{totalMistakes}}</text>
        <text class="stats-label">é”™é¢˜æ•°é‡</text>
      </view>
      <view class="stats-item">
        <text class="stats-number">{{totalWords}}</text>
        <text class="stats-label">æ–‡å­—è®°å½•</text>
      </view>
    </view>

    <!-- æˆå°±ç³»ç»Ÿ -->
    <view class="achievement-card">
      <view class="card-header">
        <text class="card-title">ğŸ† å­¦ä¹ æˆå°±</text>
        <text class="achievement-count">{{unlockedCount}}/{{totalAchievements}}</text>
      </view>
      <view class="achievement-list">
        <view class="achievement-item {{item.unlocked ? 'unlocked' : 'locked'}}" wx:for="{{achievements}}" wx:key="id">
          <view class="achievement-info">
            <text class="achievement-icon">{{item.icon}}</text>
            <view class="achievement-details">
              <text class="achievement-name">{{item.name}}</text>
              <text class="achievement-desc">{{item.description}}</text>
            </view>
          </view>
          <view class="achievement-status">
            <text wx:if="{{item.unlocked}}" class="status-unlocked">âœ… å·²è·å¾—</text>
            <text wx:else class="status-locked">{{item.progress}}/{{item.target}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å¥–åŠ±ç³»ç»Ÿ -->
    <view class="reward-system-card">
      <view class="card-header">
        <text class="card-title">ğŸ å¥–åŠ±ç³»ç»Ÿ</text>
        <text class="phone-status" style="color: {{getStatusColor(isPhoneRecovered)}}">
          {{getStatusText(isPhoneRecovered, phoneRecoveryDays)}}
        </text>
      </view>
      
      <!-- æ‰‹æœºä½¿ç”¨æƒçŠ¶æ€ -->
      <view class="phone-usage-status">
        <view class="usage-info">
          <view class="usage-item">
            <text class="usage-label">å¯ç”¨æ—¶é•¿</text>
            <text class="usage-value">{{formatTime(phoneUsageRights)}}</text>
          </view>
          <view class="usage-item" wx:if="{{isPhoneRecovered}}">
            <text class="usage-label">å›æ”¶å€’è®¡æ—¶</text>
            <text class="usage-value recovery">{{phoneRecoveryDays}}å¤©</text>
          </view>
        </view>
        <button class="usage-btn" bindtap="showPhoneUsageManager" disabled="{{isPhoneRecovered}}">
          {{isPhoneRecovered ? 'æ‰‹æœºå·²å›æ”¶' : 'ä½¿ç”¨æ—¶é—´'}}
        </button>
      </view>

      <!-- å¥–åŠ±è§„åˆ™è¯´æ˜ -->
      <view class="reward-rules">
        <text class="rules-title">ğŸ“‹ å¥–åŠ±è§„åˆ™</text>
        <view class="rule-item">
          <text class="rule-text">âœ… æ‰“å¡1å¤© = è·å¾—1å°æ—¶æ‰‹æœºä½¿ç”¨æƒ</text>
        </view>
        <view class="rule-item">
          <text class="rule-text">âŒ å¿˜è®°æ‰“å¡1å¤© = æ‰‹æœºå›æ”¶1å¤©</text>
        </view>
        <view class="rule-item">
          <text class="rule-text">âš ï¸ å¿˜è®°æ‰“å¡2å¤© = æ‰‹æœºå›æ”¶3å¤©</text>
        </view>
      </view>

      <!-- æœ€è¿‘å¥–åŠ±å’Œæƒ©ç½š -->
      <view class="recent-activities">
        <view class="activity-section" wx:if="{{rewardHistory.length > 0}}">
          <view class="activity-header" bindtap="showRewardHistory">
            <text class="activity-title">ğŸ‰ æœ€è¿‘å¥–åŠ±</text>
            <text class="activity-more">æŸ¥çœ‹å…¨éƒ¨ â€º</text>
          </view>
          <view class="activity-item" wx:for="{{rewardHistory}}" wx:key="id">
            <text class="activity-message">{{item.message}}</text>
            <text class="activity-date">{{item.date}}</text>
          </view>
        </view>

        <view class="activity-section" wx:if="{{penaltyHistory.length > 0}}">
          <view class="activity-header" bindtap="showPenaltyHistory">
            <text class="activity-title">âš ï¸ æœ€è¿‘æƒ©ç½š</text>
            <text class="activity-more">æŸ¥çœ‹å…¨éƒ¨ â€º</text>
          </view>
          <view class="activity-item penalty" wx:for="{{penaltyHistory}}" wx:key="id">
            <text class="activity-message">{{item.message}}</text>
            <text class="activity-date">{{item.date}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- åŠŸèƒ½èœå• -->
    <view class="menu-section">
      <view class="menu-item" bindtap="goToMistakes">
        <text class="menu-title">æˆ‘çš„é”™é¢˜æœ¬</text>
        <text class="menu-arrow">â€º</text>
      </view>
      <view class="menu-item" bindtap="exportData">
        <text class="menu-title">å¯¼å‡ºæ•°æ®</text>
        <text class="menu-arrow">â€º</text>
      </view>
      <view class="menu-item" bindtap="shareApp">
        <text class="menu-title">åˆ†äº«åº”ç”¨</text>
        <text class="menu-arrow">â€º</text>
      </view>
      <view class="menu-item" bindtap="feedback">
        <text class="menu-title">æ„è§åé¦ˆ</text>
        <text class="menu-arrow">â€º</text>
      </view>
      <view class="menu-item" bindtap="about">
        <text class="menu-title">å…³äºæˆ‘ä»¬</text>
        <text class="menu-arrow">â€º</text>
      </view>
    </view>

    <!-- è®¾ç½®é€‰é¡¹ -->
    <view class="settings-section">
      <view class="settings-item">
        <text class="settings-title">æ¯æ—¥æé†’</text>
        <switch class="settings-switch" checked="{{reminderEnabled}}" bindchange="toggleReminder"></switch>
      </view>
      <view class="settings-item">
        <text class="settings-title">æ•°æ®åŒæ­¥</text>
        <switch class="settings-switch" checked="{{syncEnabled}}" bindchange="toggleSync"></switch>
      </view>
      <view class="settings-item" bindtap="about">
        <text class="settings-title">ç¼“å­˜å¤§å°</text>
        <text class="settings-value">{{cacheSize}}</text>
      </view>
    </view>
  </view>
</view>

<!-- å¯¼å‡ºæ•°æ®å¼¹çª— -->
<view class="modal-overlay {{showExportModal ? 'show' : ''}}" bindtap="hideExportModal">
  <view class="modal-content" catchtap="">
    <view class="modal-header">
      <text class="modal-title">å¯¼å‡ºå­¦ä¹ æ•°æ®</text>
      <button class="modal-close" bindtap="hideExportModal">Ã—</button>
    </view>
    <view class="modal-body">
      <view class="export-options">
        <view class="export-option {{exportType === 'excel' ? 'selected' : ''}}" bindtap="selectExportType" data-type="excel">
          <text class="option-title">Excelè¡¨æ ¼</text>
        </view>
        <view class="export-option {{exportType === 'pdf' ? 'selected' : ''}}" bindtap="selectExportType" data-type="pdf">
          <text class="option-title">PDFæŠ¥å‘Š</text>
        </view>
      </view>
      <view class="date-range">
        <text class="range-label">æ—¶é—´èŒƒå›´ï¼š</text>
        <view class="date-options">
          <view class="date-option {{dateRange === 'week' ? 'active' : ''}}" bindtap="selectDateRange" data-range="week">è¿‘ä¸€å‘¨</view>
          <view class="date-option {{dateRange === 'month' ? 'active' : ''}}" bindtap="selectDateRange" data-range="month">è¿‘ä¸€æœˆ</view>
          <view class="date-option {{dateRange === 'all' ? 'active' : ''}}" bindtap="selectDateRange" data-range="all">å…¨éƒ¨</view>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideExportModal">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="confirmExport">å¯¼å‡º</button>
    </view>
  </view>
</view>

<!-- æ‰‹æœºä½¿ç”¨æƒç®¡ç†å¼¹çª— -->
<view class="modal-overlay {{showPhoneUsageModal ? 'show' : ''}}" bindtap="hidePhoneUsageModal">
  <view class="modal-content" catchtap="">
    <view class="modal-header">
      <text class="modal-title">ğŸ“± æ‰‹æœºä½¿ç”¨æƒç®¡ç†</text>
      <button class="modal-close" bindtap="hidePhoneUsageModal">Ã—</button>
    </view>
    <view class="modal-body">
      <!-- çŠ¶æ€å¡ç‰‡ -->
      <view class="status-card">
        <view class="status-header">
          <text class="status-icon">ğŸ“±</text>
          <view class="status-info">
            <text class="status-title">æ‰‹æœºä½¿ç”¨çŠ¶æ€</text>
            <text class="status-subtitle" style="color: {{statusColor}}">{{statusText}}</text>
          </view>
        </view>
        <view class="status-time">
          <text class="time-label">å¯ç”¨æ—¶é•¿</text>
          <text class="time-value">{{formattedUsageRights}}</text>
        </view>
      </view>

      <!-- å¿«é€Ÿä½¿ç”¨æŒ‰é’® -->
      <view class="quick-usage" wx:if="{{!isPhoneRecovered}}">
        <text class="section-title">âš¡ å¿«é€Ÿä½¿ç”¨</text>
        <view class="usage-grid">
          <button class="usage-btn small" bindtap="usePhoneTime" data-minutes="15" 
                  disabled="{{phoneUsageRights < 15}}">
            <text class="btn-time">15åˆ†é’Ÿ</text>
            <text class="btn-desc">çŸ­æš‚ä¼‘æ¯</text>
          </button>
          <button class="usage-btn small" bindtap="usePhoneTime" data-minutes="30" 
                  disabled="{{phoneUsageRights < 30}}">
            <text class="btn-time">30åˆ†é’Ÿ</text>
            <text class="btn-desc">å¨±ä¹æ—¶é—´</text>
          </button>
          <button class="usage-btn large" bindtap="usePhoneTime" data-minutes="60" 
                  disabled="{{phoneUsageRights < 60}}">
            <text class="btn-time">1å°æ—¶</text>
            <text class="btn-desc">è‡ªç”±ä½¿ç”¨</text>
          </button>
          <button class="usage-btn large" bindtap="usePhoneTime" data-minutes="120" 
                  disabled="{{phoneUsageRights < 120}}">
            <text class="btn-time">2å°æ—¶</text>
            <text class="btn-desc">é•¿æ—¶é—´ä½¿ç”¨</text>
          </button>
        </view>
      </view>

      <!-- å›æ”¶çŠ¶æ€æç¤º -->
      <view class="recovery-notice" wx:if="{{isPhoneRecovered}}">
        <text class="notice-icon">ğŸš«</text>
        <view class="notice-content">
          <text class="notice-title">æ‰‹æœºå·²è¢«å›æ”¶</text>
          <text class="notice-desc">è¿˜éœ€ç­‰å¾… {{phoneRecoveryDays}} å¤©æ‰èƒ½ä½¿ç”¨</text>
          <text class="notice-tip">åšæŒæ‰“å¡å¯ä»¥é¿å…æ‰‹æœºè¢«å›æ”¶</text>
        </view>
      </view>

      <!-- ä½¿ç”¨ç»Ÿè®¡ -->
      <view class="usage-stats" wx:if="{{syncResult}}">
        <text class="section-title">ğŸ“Š ä½¿ç”¨ç»Ÿè®¡</text>
        <view class="stats-grid">
          <view class="stat-item">
            <text class="stat-value">{{formatTime(syncResult.shouldHave)}}</text>
            <text class="stat-label">æ€»è·å¾—</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{formatTime(syncResult.used)}}</text>
            <text class="stat-label">å·²ä½¿ç”¨</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{formatTime(syncResult.penalty)}}</text>
            <text class="stat-label">è¢«æ‰£é™¤</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{formatTime(syncResult.available)}}</text>
            <text class="stat-label">å¯ä½¿ç”¨</text>
          </view>
        </view>
      </view>
      
      <!-- ä½¿ç”¨æç¤º -->
      <view class="usage-tips">
        <text class="tips-title">ğŸ’¡ ä½¿ç”¨è¯´æ˜</text>
        <view class="tips-list">
          <text class="tips-item">â€¢ æ¯å¤©æ‰“å¡è·å¾—1å°æ—¶ä½¿ç”¨æƒ</text>
          <text class="tips-item">â€¢ è¿ç»­7å¤©é¢å¤–è·å¾—2å°æ—¶</text>
          <text class="tips-item">â€¢ å¿˜è®°æ‰“å¡ä¼šè¢«æ‰£é™¤ä½¿ç”¨æƒ</text>
          <text class="tips-item">â€¢ ä½¿ç”¨æ—¶é•¿å®æ—¶ä»ä½™é¢ä¸­æ‰£é™¤</text>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- å¥–åŠ±å†å²å¼¹çª— -->
<view class="modal-overlay {{showRewardModal ? 'show' : ''}}" bindtap="hideRewardModal">
  <view class="modal-content" catchtap="">
    <view class="modal-header">
      <text class="modal-title">ğŸ‰ å¥–åŠ±å†å²</text>
      <button class="modal-close" bindtap="hideRewardModal">Ã—</button>
    </view>
    <view class="modal-body">
      <view class="history-list">
        <view class="history-item" wx:for="{{rewardHistory}}" wx:key="id">
          <view class="history-content">
            <text class="history-title">{{item.title}}</text>
            <text class="history-message">{{item.message}}</text>
          </view>
          <view class="history-meta">
            <text class="history-date">{{item.date}}</text>
            <text class="history-reward" wx:if="{{item.phoneTime}}">+{{formatTime(item.phoneTime)}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- æƒ©ç½šå†å²å¼¹çª— -->
<view class="modal-overlay {{showPenaltyModal ? 'show' : ''}}" bindtap="hidePenaltyModal">
  <view class="modal-content" catchtap="">
    <view class="modal-header">
      <text class="modal-title">âš ï¸ æƒ©ç½šå†å²</text>
      <button class="modal-close" bindtap="hidePenaltyModal">Ã—</button>
    </view>
    <view class="modal-body">
      <view class="history-list">
        <view class="history-item penalty" wx:for="{{penaltyHistory}}" wx:key="id">
          <view class="history-content">
            <text class="history-title">{{item.title}}</text>
            <text class="history-message">{{item.message}}</text>
          </view>
          <view class="history-meta">
            <text class="history-date">{{item.date}}</text>
            <text class="history-penalty" wx:if="{{item.recoveryDays}}">å›æ”¶{{item.recoveryDays}}å¤©</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>